-- ========================================
-- KEY SYSTEM - Mit deinen Edge Functions
-- ========================================

do
    -- Deine Supabase Edge Functions
    local SUPABASE_URL = "https://iesugielppyhhvtdzsqq.supabase.co"
    local ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imllc3VnaWVscHB5aGh2dGR6c3FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4ODAyMDUsImV4cCI6MjA2MTQ1NjIwNX0.QQYxM6pz6h9IGWYGxysvW8p1KFmHk3O_RdqnpwJYE8w"
    
    local Players = game:GetService("Players")
    local HttpService = game:GetService("HttpService")
    local TweenService = game:GetService("TweenService")
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- Key System bereits ausgef√ºhrt? Skip!
    if _G.KeySystemPassed then
        print("üîë Key System bereits bestanden!")
        return
    end
    
    print("üöÄ Key System startet...")
    print("üì° Supabase:", SUPABASE_URL)
    
    -- HTTP Check
    local httpWorks = pcall(function() 
        return HttpService:GetAsync("https://httpbin.org/get") 
    end)
    
    if not httpWorks then
        warn("‚ùå HTTP Requests blockiert!")
        return
    end
    
    print("‚úÖ HTTP funktioniert")
    
    local function createKeyGUI()
        local gui = Instance.new("ScreenGui")
        gui.Name = "KeySystem_" .. tick()
        gui.ResetOnSpawn = false
        gui.DisplayOrder = 999999
        
        -- Executor compatibility
        if syn and syn.protect_gui then 
            syn.protect_gui(gui)
            print("üõ°Ô∏è GUI Protection aktiviert (Synapse)")
        end
        
        gui.Parent = gethui and gethui() or playerGui
        print("üì∫ GUI erstellt")
        
        -- Main Frame
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 400, 0, 300)
        frame.Position = UDim2.new(0.5, -200, 0.5, -150)
        frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        frame.BorderSizePixel = 0
        frame.Parent = gui
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 12)
        corner.Parent = frame
        
        -- Title
        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(1, -20, 0, 50)
        title.Position = UDim2.new(0, 10, 0, 10)
        title.BackgroundTransparency = 1
        title.Text = "üîê ORBIT KEY SYSTEM"
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.TextScaled = true
        title.Font = Enum.Font.GothamBold
        title.Parent = frame
        
        -- Subtitle
        local subtitle = Instance.new("TextLabel")
        subtitle.Size = UDim2.new(1, -20, 0, 20)
        subtitle.Position = UDim2.new(0, 10, 0, 65)
        subtitle.BackgroundTransparency = 1
        subtitle.Text = "Erstelle einen Key auf orbit-script-forge.lovable.app"
        subtitle.TextColor3 = Color3.fromRGB(180, 180, 180)
        subtitle.TextSize = 12
        subtitle.Font = Enum.Font.Gotham
        subtitle.Parent = frame
        
        -- Key Input
        local input = Instance.new("TextBox")
        input.Size = UDim2.new(1, -40, 0, 40)
        input.Position = UDim2.new(0, 20, 0, 100)
        input.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        input.BorderSizePixel = 0
        input.PlaceholderText = "Deinen Key hier eingeben..."
        input.Text = ""
        input.TextColor3 = Color3.fromRGB(255, 255, 255)
        input.TextSize = 14
        input.Font = Enum.Font.Gotham
        input.Parent = frame
        
        local inputCorner = Instance.new("UICorner")
        inputCorner.CornerRadius = UDim.new(0, 8)
        inputCorner.Parent = input
        
        -- Verify Button
        local verifyBtn = Instance.new("TextButton")
        verifyBtn.Size = UDim2.new(0.45, 0, 0, 35)
        verifyBtn.Position = UDim2.new(0.05, 0, 0, 160)
        verifyBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 80)
        verifyBtn.BorderSizePixel = 0
        verifyBtn.Text = "‚úì VERIFIZIEREN"
        verifyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        verifyBtn.TextSize = 13
        verifyBtn.Font = Enum.Font.GothamBold
        verifyBtn.Parent = frame
        
        local verifyCorner = Instance.new("UICorner")
        verifyCorner.CornerRadius = UDim.new(0, 8)
        verifyCorner.Parent = verifyBtn
        
        -- Website Button
        local websiteBtn = Instance.new("TextButton")
        websiteBtn.Size = UDim2.new(0.45, 0, 0, 35)
        websiteBtn.Position = UDim2.new(0.5, 0, 0, 160)
        websiteBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 255)
        websiteBtn.BorderSizePixel = 0
        websiteBtn.Text = "üåê WEBSITE"
        websiteBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        websiteBtn.TextSize = 13
        websiteBtn.Font = Enum.Font.GothamBold
        websiteBtn.Parent = frame
        
        local websiteCorner = Instance.new("UICorner")
        websiteCorner.CornerRadius = UDim.new(0, 8)
        websiteCorner.Parent = websiteBtn
        
        -- Status
        local status = Instance.new("TextLabel")
        status.Size = UDim2.new(1, -20, 0, 80)
        status.Position = UDim2.new(0, 10, 0, 210)
        status.BackgroundTransparency = 1
        status.Text = "Bereit f√ºr Key Eingabe..."
        status.TextColor3 = Color3.fromRGB(200, 200, 200)
        status.TextSize = 12
        status.Font = Enum.Font.Gotham
        status.TextWrapped = true
        status.Parent = frame
        
        return gui, frame, input, verifyBtn, websiteBtn, status
    end
    
    local function showStatus(statusLabel, message, isError)
        statusLabel.Text = message
        statusLabel.TextColor3 = isError and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
        print("üì± Status:", message)
    end
    
    -- Edge Function: verify-linkvertise-hash
    local function verifyKey(key, statusLabel, gui)
        showStatus(statusLabel, "üîÑ Verifiziere Key mit Supabase...", false)
        
        local success, response = pcall(function()
            return HttpService:RequestAsync({
                Url = SUPABASE_URL .. "/functions/v1/verify-linkvertise-hash",
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json",
                    ["Authorization"] = "Bearer " .. ANON_KEY
                },
                Body = HttpService:JSONEncode({
                    hash = key,
                    userId = tostring(player.UserId),
                    username = player.Name,
                    robloxGame = tostring(game.GameId)
                })
            })
        end)
        
        print("üîç Verify Response:", success, response and response.StatusCode)
        
        if success and response.StatusCode == 200 then
            local data = HttpService:JSONDecode(response.Body)
            print("üîç Response Data:", data)
            
            if data.valid then
                showStatus(statusLabel, "‚úÖ Key g√ºltig! Script wird geladen...", false)
                _G.KeySystemPassed = true
                
                task.wait(1)
                gui:Destroy()
                
                pcall(function()
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "üéâ Orbit Key System";
                        Text = "Erfolgreich authentifiziert!";
                        Duration = 3;
                    })
                end)
                
                return true
            else
                showStatus(statusLabel, "‚ùå " .. (data.error or "Key ung√ºltig oder abgelaufen!"), true)
                return false
            end
        else
            local errorMsg = "Verbindungsfehler"
            if response then
                errorMsg = errorMsg .. " (Code: " .. response.StatusCode .. ")"
                if response.Body then
                    print("üîç Error Body:", response.Body)
                end
            end
            showStatus(statusLabel, "‚ùå " .. errorMsg, true)
            return false
        end
    end
    
    -- Edge Function: get-discord-oauth-url (falls du das willst)
    local function getDiscordLink(statusLabel)
        showStatus(statusLabel, "üîÑ Erstelle Discord Link...", false)
        
        local success, response = pcall(function()
            return HttpService:RequestAsync({
                Url = SUPABASE_URL .. "/functions/v1/get-discord-oauth-url", 
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json",
                    ["Authorization"] = "Bearer " .. ANON_KEY
                },
                Body = HttpService:JSONEncode({
                    userId = tostring(player.UserId),
                    username = player.Name
                })
            })
        end)
        
        if success and response.StatusCode == 200 then
            local data = HttpService:JSONDecode(response.Body)
            if data.url then
                showStatus(statusLabel, "‚úÖ Discord Link erstellt! Check Output.", false)
                print("üîó DISCORD LINK:", data.url)
                
                pcall(function()
                    game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", {
                        Text = "üîó Discord: " .. data.url;
                        Color = Color3.fromRGB(114, 137, 218);
                    })
                end)
            end
        else
            showStatus(statusLabel, "‚ùå Discord Link Fehler", true)
        end
    end
    
    local function openWebsite(statusLabel)
        local website = "https://orbit-script-forge.lovable.app/"
        showStatus(statusLabel, "üåê Website Link bereitgestellt!", false)
        
        print("üåê WEBSITE:", website)
        
        pcall(function()
            game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", {
                Text = "üåê Key erstellen: " .. website;
                Color = Color3.fromRGB(100, 150, 255);
            })
        end)
        
        if setclipboard then
            setclipboard(website)
            showStatus(statusLabel, "üåê Website Link in Clipboard kopiert!", false)
        end
    end
    
    -- Key System starten
    local function startKeySystem()
        local gui, frame, input, verifyBtn, websiteBtn, status = createKeyGUI()
        
        -- Entrance Animation
        frame.Size = UDim2.new(0, 0, 0, 0)
        frame.Position = UDim2.new(0.5, 0, 0.5, 0)
        
        local entranceAnim = TweenService:Create(frame, TweenInfo.new(0.6, Enum.EasingStyle.Back), {
            Size = UDim2.new(0, 400, 0, 300),
            Position = UDim2.new(0.5, -200, 0.5, -150)
        })
        entranceAnim:Play()
        
        -- Events
        verifyBtn.MouseButton1Click:Connect(function()
            local key = input.Text:gsub("%s+", "")
            if key == "" then
                showStatus(status, "‚ùå Bitte Key eingeben!", true)
                return
            end
            
            print("üîë Teste Key:", key)
            verifyKey(key, status, gui)
        end)
        
        websiteBtn.MouseButton1Click:Connect(function()
            openWebsite(status)
            -- Optional: Discord Link auch erstellen
            -- getDiscordLink(status)
        end)
        
        -- Enter key support
        input.FocusLost:Connect(function(enterPressed)
            if enterPressed and input.Text ~= "" then
                verifyBtn.MouseButton1Click:Fire()
            end
        end)
        
        input:CaptureFocus()
        
        -- Warten bis Key verifiziert ist
        repeat task.wait(0.1) until _G.KeySystemPassed or not gui.Parent
        
        if not _G.KeySystemPassed then
            print("‚ùå Key System abgebrochen")
            return false
        end
        
        return true
    end
    
    -- Key System ausf√ºhren
    if startKeySystem() then
        print("üéâ Key System erfolgreich! Script wird fortgesetzt...")
    else
        print("‚ùå Key System fehlgeschlagen!")
        return
    end
end

-- ========================================
-- AB HIER DEIN EXECUTOR CODE  
-- ========================================

print("üöÄ Dein Script l√§uft jetzt!")
