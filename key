-- ========================================
-- KEY SYSTEM - F√ºr Website Keys
-- ========================================

do
    local API_BASE = "https://iesugielppyhhvtdzsqq.supabase.co/functions/v1"
    local WEBSITE_URL = "https://orbit-script-forge.lovable.app/"
    local Players = game:GetService("Players")
    local HttpService = game:GetService("HttpService")
    local TweenService = game:GetService("TweenService")
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- Key System bereits ausgef√ºhrt? Skip!
    if _G.KeySystemPassed then
        return
    end
    
    -- HTTP Check
    if not pcall(function() HttpService:GetAsync("https://httpbin.org/get") end) then
        warn("‚ùå HTTP Requests blockiert!")
        return
    end
    
    local function createKeyGUI()
        local gui = Instance.new("ScreenGui")
        gui.Name = "KeySystem_" .. tick()
        gui.ResetOnSpawn = false
        gui.DisplayOrder = 999999
        
        -- Executor compatibility
        if syn and syn.protect_gui then syn.protect_gui(gui) end
        gui.Parent = gethui and gethui() or playerGui
        
        -- Blur Background
        local blur = Instance.new("BlurEffect")
        blur.Size = 20
        if game.Workspace.CurrentCamera then
            blur.Parent = game.Workspace.CurrentCamera
        end
        
        -- Main Frame
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 450, 0, 320)
        frame.Position = UDim2.new(0.5, -225, 0.5, -160)
        frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
        frame.BorderSizePixel = 0
        frame.Parent = gui
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 15)
        corner.Parent = frame
        
        -- Header
        local header = Instance.new("Frame")
        header.Size = UDim2.new(1, 0, 0, 80)
        header.Position = UDim2.new(0, 0, 0, 0)
        header.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
        header.BorderSizePixel = 0
        header.Parent = frame
        
        local headerCorner = Instance.new("UICorner")
        headerCorner.CornerRadius = UDim.new(0, 15)
        headerCorner.Parent = header
        
        local headerBottom = Instance.new("Frame")
        headerBottom.Size = UDim2.new(1, 0, 0, 15)
        headerBottom.Position = UDim2.new(0, 0, 1, -15)
        headerBottom.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
        headerBottom.BorderSizePixel = 0
        headerBottom.Parent = header
        
        -- Title
        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(1, -20, 0, 30)
        title.Position = UDim2.new(0, 10, 0, 10)
        title.BackgroundTransparency = 1
        title.Text = "üîê KEY SYSTEM"
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.TextSize = 24
        title.Font = Enum.Font.GothamBold
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Parent = header
        
        -- Subtitle
        local subtitle = Instance.new("TextLabel")
        subtitle.Size = UDim2.new(1, -20, 0, 20)
        subtitle.Position = UDim2.new(0, 10, 0, 45)
        subtitle.BackgroundTransparency = 1
        subtitle.Text = "Erstelle einen Key auf der Website"
        subtitle.TextColor3 = Color3.fromRGB(180, 180, 180)
        subtitle.TextSize = 14
        subtitle.Font = Enum.Font.Gotham
        subtitle.TextXAlignment = Enum.TextXAlignment.Left
        subtitle.Parent = header
        
        -- Instructions
        local instructions = Instance.new("TextLabel")
        instructions.Size = UDim2.new(1, -40, 0, 40)
        instructions.Position = UDim2.new(0, 20, 0, 90)
        instructions.BackgroundTransparency = 1
        instructions.Text = "1. Gehe auf die Website\n2. Erstelle einen Key\n3. Gib den Key hier ein"
        instructions.TextColor3 = Color3.fromRGB(200, 200, 200)
        instructions.TextSize = 13
        instructions.Font = Enum.Font.Gotham
        instructions.TextXAlignment = Enum.TextXAlignment.Left
        instructions.TextYAlignment = Enum.TextYAlignment.Top
        instructions.Parent = frame
        
        -- Key Input Container
        local inputContainer = Instance.new("Frame")
        inputContainer.Size = UDim2.new(1, -40, 0, 45)
        inputContainer.Position = UDim2.new(0, 20, 0, 145)
        inputContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
        inputContainer.BorderSizePixel = 0
        inputContainer.Parent = frame
        
        local inputCorner = Instance.new("UICorner")
        inputCorner.CornerRadius = UDim.new(0, 10)
        inputCorner.Parent = inputContainer
        
        -- Key Input
        local input = Instance.new("TextBox")
        input.Size = UDim2.new(1, -20, 1, -10)
        input.Position = UDim2.new(0, 10, 0, 5)
        input.BackgroundTransparency = 1
        input.PlaceholderText = "Deinen Key hier eingeben..."
        input.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
        input.Text = ""
        input.TextColor3 = Color3.fromRGB(255, 255, 255)
        input.TextSize = 16
        input.Font = Enum.Font.Gotham
        input.TextXAlignment = Enum.TextXAlignment.Left
        input.Parent = inputContainer
        
        -- Button Container
        local buttonContainer = Instance.new("Frame")
        buttonContainer.Size = UDim2.new(1, -40, 0, 45)
        buttonContainer.Position = UDim2.new(0, 20, 0, 210)
        buttonContainer.BackgroundTransparency = 1
        buttonContainer.Parent = frame
        
        -- Verify Button
        local verifyBtn = Instance.new("TextButton")
        verifyBtn.Size = UDim2.new(0.48, 0, 1, 0)
        verifyBtn.Position = UDim2.new(0, 0, 0, 0)
        verifyBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        verifyBtn.BorderSizePixel = 0
        verifyBtn.Text = "‚úì KEY PR√úFEN"
        verifyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        verifyBtn.TextSize = 16
        verifyBtn.Font = Enum.Font.GothamBold
        verifyBtn.Parent = buttonContainer
        
        local verifyCorner = Instance.new("UICorner")
        verifyCorner.CornerRadius = UDim.new(0, 10)
        verifyCorner.Parent = verifyBtn
        
        -- Website Button
        local websiteBtn = Instance.new("TextButton")
        websiteBtn.Size = UDim2.new(0.48, 0, 1, 0)
        websiteBtn.Position = UDim2.new(0.52, 0, 0, 0)
        websiteBtn.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
        websiteBtn.BorderSizePixel = 0
        websiteBtn.Text = "üåê WEBSITE"
        websiteBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        websiteBtn.TextSize = 16
        websiteBtn.Font = Enum.Font.GothamBold
        websiteBtn.Parent = buttonContainer
        
        local websiteCorner = Instance.new("UICorner")
        websiteCorner.CornerRadius = UDim.new(0, 10)
        websiteCorner.Parent = websiteBtn
        
        -- Status
        local status = Instance.new("TextLabel")
        status.Size = UDim2.new(1, -40, 0, 50)
        status.Position = UDim2.new(0, 20, 0, 265)
        status.BackgroundTransparency = 1
        status.Text = ""
        status.TextColor3 = Color3.fromRGB(255, 100, 100)
        status.TextSize = 14
        status.Font = Enum.Font.Gotham
        status.TextWrapped = true
        status.TextXAlignment = Enum.TextXAlignment.Center
        status.Parent = frame
        
        return gui, frame, input, verifyBtn, websiteBtn, status, blur
    end
    
    local function showStatus(statusLabel, message, isError)
        statusLabel.Text = message
        statusLabel.TextColor3 = isError and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
        
        task.spawn(function()
            task.wait(5)
            statusLabel.Text = ""
        end)
    end
    
    local function buttonAnimation(button, callback)
        local originalSize = button.Size
        local pressedSize = UDim2.new(originalSize.X.Scale * 0.95, originalSize.X.Offset, originalSize.Y.Scale * 0.95, originalSize.Y.Offset)
        
        button.MouseButton1Click:Connect(function()
            -- Button press animation
            local pressDown = TweenService:Create(button, TweenInfo.new(0.1), {Size = pressedSize})
            local pressUp = TweenService:Create(button, TweenInfo.new(0.1), {Size = originalSize})
            
            pressDown:Play()
            pressDown.Completed:Connect(function()
                pressUp:Play()
                callback()
            end)
        end)
    end
    
    local function makeRequest(endpoint, data)
        local success, response = pcall(function()
            return HttpService:RequestAsync({
                Url = API_BASE .. "/" .. endpoint,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data or {})
            })
        end)
        
        if success and response.StatusCode == 200 then
            return true, HttpService:JSONDecode(response.Body)
        else
            return false, response and response.Body or "Netzwerk Fehler"
        end
    end
    
    local function verifyKey(key, statusLabel, gui)
        showStatus(statusLabel, "üîÑ Verifiziere Key...", false)
        
        local success, response = makeRequest("verify-linkvertise-hash", {
            hash = key,
            userId = tostring(player.UserId),
            username = player.Name
        })
        
        if success and response.valid then
            showStatus(statusLabel, "‚úÖ Key g√ºltig! Script wird geladen...", false)
            _G.KeySystemPassed = true
            
            -- Success animation
            local successTween = TweenService:Create(gui.Frame, TweenInfo.new(0.5), {
                BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            })
            successTween:Play()
            
            task.wait(1.5)
            
            -- Fade out
            local fadeOut = TweenService:Create(gui.Frame, TweenInfo.new(0.5), {
                Size = UDim2.new(0, 0, 0, 0),
                Position = UDim2.new(0.5, 0, 0.5, 0),
                BackgroundTransparency = 1
            })
            fadeOut:Play()
            
            fadeOut.Completed:Connect(function()
                gui:Destroy()
            end)
            
            -- Success notification
            pcall(function()
                game:GetService("StarterGui"):SetCore("SendNotification", {
                    Title = "üéâ Key System";
                    Text = "Erfolgreich authentifiziert!";
                    Duration = 3;
                })
            end)
            
            return true
        else
            local errorMsg = response.error or "Ung√ºltiger Key!"
            showStatus(statusLabel, "‚ùå " .. errorMsg, true)
            
            -- Error shake animation
            local originalPos = gui.Frame.Position
            local shakeDistance = 10
            
            for i = 1, 3 do
                TweenService:Create(gui.Frame, TweenInfo.new(0.1), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset + shakeDistance, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.1)
                TweenService:Create(gui.Frame, TweenInfo.new(0.1), {
                    Position = UDim2.new(originalPos.X.Scale, originalPos.X.Offset - shakeDistance, originalPos.Y.Scale, originalPos.Y.Offset)
                }):Play()
                task.wait(0.1)
            end
            
            TweenService:Create(gui.Frame, TweenInfo.new(0.1), {Position = originalPos}):Play()
            
            return false
        end
    end
    
    local function openWebsite(statusLabel)
        showStatus(statusLabel, "üåê Website Link wurde erstellt!", false)
        
        -- Website URL in verschiedenen Wegen bereitstellen
        print("üåê WEBSITE:", WEBSITE_URL)
        
        -- Chat Message
        pcall(function()
            game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", {
                Text = "üåê Key erstellen: " .. WEBSITE_URL;
                Color = Color3.fromRGB(100, 150, 255);
            })
        end)
        
        -- Notification
        pcall(function()
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "üåê Key Website";
                Text = "Link wurde in Chat/Output gesendet!";
                Duration = 5;
            })
        end)
        
        -- Clipboard (falls unterst√ºtzt)
        if setclipboard then
            setclipboard(WEBSITE_URL)
            showStatus(statusLabel, "üåê Website Link in Clipboard kopiert!", false)
        end
    end
    
    -- Key System starten
    local function startKeySystem()
        local gui, frame, input, verifyBtn, websiteBtn, status, blur = createKeyGUI()
        
        -- Entrance Animation
        frame.Size = UDim2.new(0, 0, 0, 0)
        frame.Position = UDim2.new(0.5, 0, 0.5, 0)
        frame.BackgroundTransparency = 1
        
        local entranceAnim = TweenService:Create(frame, TweenInfo.new(0.8, Enum.EasingStyle.Back), {
            Size = UDim2.new(0, 450, 0, 320),
            Position = UDim2.new(0.5, -225, 0.5, -160),
            BackgroundTransparency = 0
        })
        entranceAnim:Play()
        
        -- Button Animations & Events
        buttonAnimation(verifyBtn, function()
            local key = input.Text:gsub("%s+", "")
            if key == "" then
                showStatus(status, "‚ùå Bitte gib einen Key ein!", true)
                return
            end
            
            if verifyKey(key, status, gui) then
                return
            end
        end)
        
        buttonAnimation(websiteBtn, function()
            openWebsite(status)
        end)
        
        -- Enter key support
        input.FocusLost:Connect(function(enterPressed)
            if enterPressed and input.Text ~= "" then
                verifyBtn.MouseButton1Click:Fire()
            end
        end)
        
        -- Auto-focus
        input:CaptureFocus()
        
        -- Warten bis Key verifiziert ist
        repeat task.wait(0.1) until _G.KeySystemPassed or not gui.Parent
        
        if blur then blur:Destroy() end
        
        if not _G.KeySystemPassed then
            return
        end
    end
    
    -- Key System ausf√ºhren
    startKeySystem()
    
    print("üéâ Key System erfolgreich! Script wird fortgesetzt...")
end

-- ========================================
-- AB HIER DEIN NORMALER SCRIPT CODE
-- ========================================
